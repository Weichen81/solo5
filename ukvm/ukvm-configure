#!/bin/bash
# Copyright (c) 2015-2017 Contributors as noted in the AUTHORS file
#
# This file is part of ukvm, a unikernel monitor.
#
# Permission to use, copy, modify, and/or distribute this software
# for any purpose with or without fee is hereby granted, provided
# that the above copyright notice and this permission notice appear
# in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
# WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED
# WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
# AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR
# CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS
# OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT,
# NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN
# CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

if [ "$#" -lt 1 ]; then
    echo "Usage: ukvm-configure UKVM_SRC [MODULES]"
    echo "    UKVM_SRC is /path/to/ukvm"
    echo "    MODULES can be any combination of: net blk gdb"
    exit 1
fi

UKVM_SRC=`readlink -f $1`
if [ ! -d ${UKVM_SRC} -o ! -f ${UKVM_SRC}/ukvm-core.c ]; then
    echo "Error: Not a ukvm source directory: ${UKVM_SRC}" 1>&2
    exit 1
fi
shift
UKVM_MODULES=$@

cat <<EOF> Makefile.ukvm
# Generated by ukvm-configure $@

# Get ARCH from environment variables, if ARCH doesn't exist, we will retrieve
# ARCH through 'uname -m'.
ARCH ?= \$(shell uname -m)

# Unify the 64-bit ARM architecture to arm64
ifeq (\$(ARCH), aarch64)
ARCH = arm64
endif

# Include UKVM_ARCH_OBJS from ukvm ARCH folder
include \$(UKVM_SRC)/\$(ARCH)/Makefile.objs

UKVM_ARCH_OBJS=\$(addprefix _build-ukvm/\$(ARCH)/,\${ARCH_OBJS})

UKVM_MODULE_OBJS=\$(addsuffix .o,\$(addprefix _build-ukvm/ukvm-,${UKVM_MODULES}))
UKVM_MODULE_FLAGS=\$(addprefix -DUKVM_MODULE_,\$(shell echo ${UKVM_MODULES}| tr '[:lower:]' '[:upper:]'))

UKVM_CC?=cc
UKVM_FLAGS=-D__UKVM_HOST__ \$(UKVM_MODULE_FLAGS) -I$UKVM_SRC/ -I$UKVM_SRC/\$(ARCH)
UKVM_CFLAGS=-Wall -Werror -std=c99 -O2 -g \$(UKVM_FLAGS)

ifeq (\$(ARCH), x86_64)
UKVM_CFLAGS += -DCONFIG_X86_64
endif

ifeq (\$(ARCH), arm64)
UKVM_CFLAGS += -DCONFIG_ARM64
endif

UKVM_OBJS=_build-ukvm/ukvm-core.o \$(UKVM_ARCH_OBJS) \$(UKVM_MODULE_OBJS)
ifdef UKVM_STATIC
UKVM_LDFLAGS=-static
endif
UKVM_HEADERS= \\
$UKVM_SRC/ukvm-private.h \\
$UKVM_SRC/ukvm-modules.h \\
$UKVM_SRC/ukvm-cpu.h \\
$UKVM_SRC/ukvm.h

_build-ukvm:
	mkdir -p _build-ukvm

_build-ukvm/\$(ARCH):
	mkdir -p _build-ukvm/\$(ARCH)

_build-ukvm/ukvm-%.o: $UKVM_SRC/ukvm-%.c \$(MAKEFILE_LIST) | _build-ukvm
	\$(UKVM_CC) \$(UKVM_CFLAGS) -c \$< -o \$@

_build-ukvm/\$(ARCH)/ukvm-%.o: $UKVM_SRC/\$(ARCH)/ukvm-%.c \$(MAKEFILE_LIST) | _build-ukvm/\$(ARCH)
	\$(UKVM_CC) \$(UKVM_CFLAGS) -c \$< -o \$@

ukvm-bin: \$(UKVM_OBJS) \$(UKVM_HEADERS) \$(MAKEFILE_LIST)
	\$(UKVM_CC) \$(UKVM_LDFLAGS) -o \$@ \$(UKVM_CFLAGS) \$(UKVM_OBJS)

.PHONY: ukvm-clean
ukvm-clean:
	\$(RM) -r _build-ukvm
	\$(RM) ukvm-bin

EOF

